import tkinter as tk
from tkinter import ttk, messagebox, filedialog, simpledialog
import json

# Traductions pour plusieurs langues
translations = {
    "gb": {"title": "Kanban Board", "todo": "To Do", "inProgress": "In Progress", "done": "Done",
           "addTask": "Add Task", "export": "Export", "import": "Import", "language": "Language",
           "delete": "Delete", "confirmDelete": "Delete this task?", "priority": "Priority",
           "high": "High", "medium": "Medium", "low": "Low", "cancel": "Cancel", "save": "Save",
           "resetConfirm": "Reset all tasks?", "importError": "Invalid file format", "creator": "Created by Yglsan"},
    "fr": {"title": "Tableau Kanban", "todo": "Ã€ Faire", "inProgress": "En Cours", "done": "TerminÃ©",
           "addTask": "Ajouter TÃ¢che", "export": "Exporter", "import": "Importer", "language": "Langue",
           "delete": "Supprimer", "confirmDelete": "Supprimer cette tÃ¢che ?", "priority": "PrioritÃ©",
           "high": "Haute", "medium": "Moyenne", "low": "Basse", "cancel": "Annuler", "save": "Enregistrer",
           "resetConfirm": "RÃ©initialiser toutes les tÃ¢ches ?", "importError": "Format de fichier invalide", "creator": "CrÃ©Ã© par Yglsan"},
    "de": { "title": "Kanban-Board", "todo": "Zu Erledigen", "inProgress": "In Bearbeitung", "done": "Fertig",
            "addTask": "Aufgabe HinzufÃ¼gen", "export": "Exportieren", "import": "Importieren", "language": "Sprache",
            "delete": "LÃ¶schen", "confirmDelete": "Diese Aufgabe lÃ¶schen?", "priority": "PrioritÃ¤t", "high": "Hoch", "medium": "Mittel",
            "low": "Niedrig", "cancel": "Abbrechen", "save": "Speichern", "resetConfirm": "Alle Aufgaben zurÃ¼cksetzen?", "importError": "UngÃ¼ltiges Dateiformat", "creator": "Erstellt von Yglsan" },
    "it": { "title": "Bacheca Kanban", "todo": "Da Fare", "inProgress": "In Corso", "done": "Fatto", "addTask": "Aggiungi Compito",
            "export": "Esporta", "import": "Importa", "language": "Lingua", "delete": "Elimina", "confirmDelete": "Eliminare questo compito?",
            "priority": "PrioritÃ ", "high": "Alta", "medium": "Media", "low": "Bassa", "cancel": "Annulla", "save": "Salva",
            "resetConfirm": "Ripristinare tutte le attivitÃ ?", "importError": "Formato file non valido", "creator": "Creato da Yglsan" },
    "es": { "title": "Tablero Kanban", "todo": "Por Hacer", "inProgress": "En Progreso", "done": "Hecho", "addTask": "Agregar Tarea", "export":
            "Exportar", "import": "Importar", "language": "Idioma", "delete": "Eliminar", "confirmDelete": "Â¿Eliminar esta tarea?", "priority": "Prioridad",
            "high": "Alta", "medium": "Media", "low": "Baja", "cancel": "Cancelar", "save": "Guardar", "resetConfirm": "Â¿Restablecer todas las tareas?",
            "importError": "Formato de archivo no vÃ¡lido", "creator": "Creado por Yglsan" },
    "jp": { "title": "ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰", "todo": "ã‚„ã‚‹ã“ã¨", "inProgress": "é€²è¡Œä¸­", "done": "å®Œäº†", "addTask": "ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ", "export": "ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ", "import": "ã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
            "language": "è¨€èª", "delete": "å‰Šé™¤", "confirmDelete": "ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", "priority": "å„ªå…ˆåº¦", "high": "é«˜", "medium": "ä¸­", "low": "ä½",
            "cancel": "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", "save": "ä¿å­˜", "resetConfirm": "ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ", "importError": "ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼", "creator": "Yglsanã«ã‚ˆã£ã¦ä½œæˆ" },
    "kr": { "title": "ì¹¸ë°˜ ë³´ë“œ", "todo": "í•´ì•¼ í•  ì¼", "inProgress": "ì§„í–‰ ì¤‘", "done": "ì™„ë£Œ", "addTask": "ì‘ì—… ì¶”ê°€", "export": "ë‚´ë³´ë‚´ê¸°", "import": "ê°€ì ¸ì˜¤ê¸°",
            "language": "ì–¸ì–´", "delete": "ì‚­ì œ", "confirmDelete": "ì´ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", "priority": "ìš°ì„  ìˆœìœ„", "high": "ë†’ìŒ", "medium": "ì¤‘ê°„",
            "low": "ë‚®ìŒ", "cancel": "ì·¨ì†Œ", "save": "ì €ì¥", "resetConfirm": "ëª¨ë“  ì‘ì—…ì„ ì¬ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", "importError": "ìœ íš¨í•˜ì§€ ì•Šì€ íŒŒì¼ í˜•ì‹", "creator": "Yglsanì— ì˜í•´ ë§Œë“¤ì–´ì§" },
    "cn": { "title": "çœ‹æ¿", "todo": "å¾…åŠäº‹é¡¹", "inProgress": "è¿›è¡Œä¸­", "done": "å®Œæˆ", "addTask": "æ·»åŠ ä»»åŠ¡", "export": "å¯¼å‡º", "import": "å¯¼å…¥",
            "language": "è¯­è¨€", "delete": "åˆ é™¤", "confirmDelete": "åˆ é™¤æ­¤ä»»åŠ¡ï¼Ÿ", "priority": "ä¼˜å…ˆçº§", "high": "é«˜", "medium": "ä¸­", "low": "ä½",
            "cancel": "å–æ¶ˆ", "save": "ä¿å­˜", "resetConfirm": "é‡ç½®æ‰€æœ‰ä»»åŠ¡ï¼Ÿ", "importError": "æ— æ•ˆçš„æ–‡ä»¶æ ¼å¼", "creator": "ç”±Yglsanåˆ›å»º" },
    "lv": { "title": "Kanban dÄ“lis", "todo": "JÄdara", "inProgress": "ProcesÄ", "done": "IzpildÄ«ts", "addTask": "Pievienot uzdevumu", "export": "EksportÄ“t",
            "import": "ImportÄ“t", "language": "Valoda", "delete": "DzÄ“st", "confirmDelete": "DzÄ“st Å¡o uzdevumu?", "priority": "PrioritÄte", "high": "Augsta",
            "medium": "VidÄ“ja", "low": "Zema", "cancel": "Atcelt", "save": "SaglabÄt", "resetConfirm": "Atjaunot visus uzdevumus?", "importError": "NederÄ«gs faila formÄts", "creator": "Izveidots ar Yglsan" },
    "ru": { "title": "Ğ”Ğ¾ÑĞºĞ° ĞšĞ°Ğ½Ğ±Ğ°Ğ½", "todo": "Ğš Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ", "inProgress": "Ğ’ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞµ", "done": "Ğ¡Ğ´ĞµĞ»Ğ°Ğ½Ğ¾", "addTask": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ", "export": "Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚",
            "import": "Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚", "language": "Ğ¯Ğ·Ñ‹Ğº", "delete": "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ", "confirmDelete": "Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ñƒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ?", "priority": "ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚", "high": "Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹",
            "medium": "Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹", "low": "ĞĞ¸Ğ·ĞºĞ¸Ğ¹", "cancel": "ĞÑ‚Ğ¼ĞµĞ½Ğ°", "save": "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ", "resetConfirm": "Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸?", "importError": "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ„Ğ°Ğ¹Ğ»Ğ°", "creator": "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¾ Yglsan" },
    "pt": { "title": "Quadro Kanban", "todo": "A Fazer", "inProgress": "Em Progresso", "done": "ConcluÃ­do", "addTask": "Adicionar Tarefa", "export":
            "Exportar", "import": "Importar", "language": "Idioma", "delete": "Excluir", "confirmDelete": "Excluir esta tarefa?", "priority": "Prioridade",
            "high": "Alta", "medium": "MÃ©dia", "low": "Baixa", "cancel": "Cancelar", "save": "Salvar", "resetConfirm": "Redefinir todas as tarefas?", "importError": "Formato de arquivo invÃ¡lido", "creator": "Criado por Yglsan" },
    "sa": { "title": "Ù„ÙˆØ­Ø© ÙƒØ§Ù†Ø¨Ø§Ù†", "todo": "Ù„Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡", "inProgress": "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚Ø¯Ù…", "done": "Ù…Ù†Ø¬Ø²", "addTask": "Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©", "export": "ØªØµØ¯ÙŠØ±", "import": "Ø§Ø³ØªÙŠØ±Ø§Ø¯", "language": "Ù„ØºØ©",
            "delete": "Ø­Ø°Ù", "confirmDelete": "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ", "priority": "Ø£ÙˆÙ„ÙˆÙŠØ©", "high": "Ø¹Ø§Ù„ÙŠØ©", "medium": "Ù…ØªÙˆØ³Ø·Ø©", "low": "Ù…Ù†Ø®ÙØ¶Ø©",
            "cancel": "Ø¥Ù„ØºØ§Ø¡", "save": "Ø­ÙØ¸", "resetConfirm": "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù…ØŸ", "importError": "ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­", "creator": "Ø£Ù†Ø´Ø¦ Ø¨ÙˆØ§Ø³Ø·Ø© Yglsan" }
}

# Couleurs de prioritÃ©
priority_colors = {
    "high": "#f9e2e2",
    "medium": "#fcf3cf",
    "low": "#e8f6ee"
}

class DraggableTask(tk.Frame):
    def __init__(self, master, text, priority, column, delete_callback):
        super().__init__(master, bg=priority_colors[priority], bd=1, relief=tk.RAISED)
        self.column = column
        self.delete_callback = delete_callback

        self.task_content = tk.Label(self, text=text, bg=priority_colors[priority], font=('Arial', 10))
        self.task_content.pack(side=tk.LEFT, padx=10)

        self.priority_label = tk.Label(self, text=translations['fr'][priority],
                                     bg=priority_colors[priority], font=('Arial', 8))
        self.priority_label.pack(side=tk.LEFT, padx=10)

        self.delete_btn = tk.Label(self, text="Ã—", fg="red", cursor="hand2", font=('Arial', 10, 'bold'))
        self.delete_btn.pack(side=tk.RIGHT, padx=10)
        self.delete_btn.bind("<Button-1>", self.delete_task)

        self.bind("<ButtonPress-1>", self.start_drag)
        self.bind("<B1-Motion>", self.do_drag)
        self.bind("<ButtonRelease-1>", self.stop_drag)

    def start_drag(self, event):
        self._drag_start_x = event.x
        self._drag_start_y = event.y
        self.lift()

    def do_drag(self, event):
        x = self.winfo_x() + (event.x - self._drag_start_x)
        y = self.winfo_y() + (event.y - self._drag_start_y)
        self.place(x=x, y=y)

    def stop_drag(self, event):
        new_column = self.get_new_column(event.x_root, event.y_root)
        if new_column and new_column != self.column:
            self.master.move_task(self, new_column)
        self.place_forget()
        self.master.update_tasks()

    def get_new_column(self, x, y):
        for col in self.master.master.columns.values():
            if col.winfo_containing(x, y) == col:
                return col.id
        return None

    def delete_task(self, event=None):
        if messagebox.askyesno(translations[self.master.master.lang]["confirmDelete"],
                             translations[self.master.master.lang]["confirmDelete"]):
            self.destroy()
            self.delete_callback()

class KanbanColumn(tk.Canvas):
    def __init__(self, master, id, title):
        super().__init__(master, width=250, height=400, bg='#ecf0f1', bd=0, highlightthickness=0)
        self.id = id
        self.title = title
        self.tasks = []

        self.header = tk.Frame(self, bg='#2c3e50')
        self.title_label = tk.Label(self.header, text=title, fg='white', bg='#2c3e50', font=('Arial', 12, 'bold'))
        self.add_btn = tk.Button(self.header, text="+", font=('Arial', 10, 'bold'), command=lambda: self.master.master.add_task_dialog(self.id))

        self.header.pack(fill=tk.X, pady=5)
        self.title_label.pack(side=tk.LEFT, padx=10)
        self.add_btn.pack(side=tk.RIGHT, padx=10)

        self.create_window(0, 0, window=self.header, anchor=tk.NW, width=250)
        self.scrollable_frame = tk.Frame(self)
        self.create_window(0, 40, window=self.scrollable_frame, anchor=tk.NW)

        self.bind("<Configure>", self.on_configure)

    def on_configure(self, event):
        self.configure(scrollregion=self.bbox("all"))

    def add_task(self, text, priority):
        task = DraggableTask(self.scrollable_frame, text, priority, self.id,
                           lambda: self.remove_task(task))
        task.pack(fill=tk.X, pady=5)
        self.tasks.append(task)
        self.update_tasks()

    def move_task(self, task, new_column):
        self.tasks.remove(task)
        self.master.columns[new_column].add_task(task.task_content.cget("text"),
                                               task.priority_label.cget("text").lower())
        task.destroy()
        self.master.save_state()

    def update_tasks(self):
        for i, task in enumerate(self.tasks):
            task.pack_forget()
        for task in self.tasks:
            task.pack(fill=tk.X, pady=5)

class KanbanApp:
    def __init__(self, root):
        self.root = root
        self.lang = "fr"
        self.setup_ui()
        self.load_state()

    def setup_ui(self):
        self.root.title(translations[self.lang]["title"])
        self.root.geometry("800x500")
        self.root.configure(bg='#f5f5f5')

        # ContrÃ´les supÃ©rieurs
        self.control_frame = tk.Frame(self.root, bg='#f5f5f5')
        self.control_frame.pack(fill=tk.X, pady=10)

        self.lang_selector = ttk.Combobox(self.control_frame, values=list(translations.keys()), font=('Arial', 10))
        self.lang_selector.set(self.lang)
        self.lang_selector.pack(side=tk.LEFT, padx=10)
        self.lang_selector.bind("<<ComboboxSelected>>", self.change_language)

        self.export_btn = tk.Button(self.control_frame, text=translations[self.lang]["export"],
                                   command=self.export_tasks, font=('Arial', 10))
        self.export_btn.pack(side=tk.LEFT, padx=10)

        self.import_btn = tk.Button(self.control_frame, text=translations[self.lang]["import"],
                                   command=self.import_tasks, font=('Arial', 10))
        self.import_btn.pack(side=tk.LEFT, padx=10)

        # Colonnes
        self.columns_frame = tk.Frame(self.root, bg='#f5f5f5')
        self.columns_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        self.columns = {
            "todo": KanbanColumn(self.columns_frame, "todo", translations[self.lang]["todo"]),
            "inProgress": KanbanColumn(self.columns_frame, "inProgress", translations[self.lang]["inProgress"]),
            "done": KanbanColumn(self.columns_frame, "done", translations[self.lang]["done"])
        }

        for i, col in enumerate(self.columns.values()):
            col.grid(row=0, column=i, padx=10, pady=10, sticky=tk.NSEW)

        self.columns_frame.grid_columnconfigure(0, weight=1)
        self.columns_frame.grid_columnconfigure(1, weight=1)
        self.columns_frame.grid_columnconfigure(2, weight=1)

        # Bouton pour redimensionner la fenÃªtre
        self.resize_btn = tk.Button(self.root, text="ğŸ“", command=self.resize_window, font=('Arial', 10))
        self.resize_btn.pack(side=tk.BOTTOM, padx=10, pady=10)

        # Bouton pour dÃ©placer la fenÃªtre
        self.move_btn = tk.Button(self.root, text="ğŸ“", command=self.make_draggable, font=('Arial', 10))
        self.move_btn.pack(side=tk.BOTTOM, padx=10, pady=10)

        # Bouton pour masquer/afficher la fenÃªtre
        self.toggle_btn = tk.Button(self.root, text="ğŸ”„", command=self.toggle_visibility, font=('Arial', 10))
        self.toggle_btn.pack(side=tk.BOTTOM, padx=10, pady=10)

        # Menu dÃ©roulant pour changer la taille de la fenÃªtre
        self.size_selector = ttk.Combobox(self.control_frame, values=["small", "medium", "large"], font=('Arial', 10))
        self.size_selector.set("medium")
        self.size_selector.pack(side=tk.LEFT, padx=10)
        self.size_selector.bind("<<ComboboxSelected>>", self.change_size)

        # Ajout du crÃ©ateur de l'application
        self.creator_label = tk.Label(self.root, text=translations[self.lang]["creator"], bg='#f5f5f5', font=('Arial', 10, 'italic'))
        self.creator_label.pack(side=tk.BOTTOM, pady=10)

    def change_language(self, event):
        self.lang = self.lang_selector.get()
        self.update_ui_language()

    def update_ui_language(self):
        self.root.title(translations[self.lang]["title"])
        for col in self.columns.values():
            col.title_label.config(text=translations[self.lang][col.id])
        self.export_btn.config(text=translations[self.lang]["export"])
        self.import_btn.config(text=translations[self.lang]["import"])
        self.lang_selector.set(self.lang)
        self.creator_label.config(text=translations[self.lang]["creator"])

    def add_task_dialog(self, column_id):
        task_text = simpledialog.askstring(translations[self.lang]["addTask"], translations[self.lang]["addTask"])
        if task_text:
            priority = simpledialog.askstring(translations[self.lang]["priority"], translations[self.lang]["priority"],
                                              initialvalue=translations[self.lang]["low"])
            if priority in ["high", "medium", "low"]:
                self.columns[column_id].add_task(task_text, priority)
                self.save_state()

    def save_state(self):
        tasks = []
        for col in self.columns.values():
            tasks.extend([{
                "text": task.task_content.cget("text"),
                "priority": task.priority_label.cget("text").lower(),
                "column": col.id
            } for task in col.tasks])
        with open("kanban_state.json", "w") as f:
            json.dump(tasks, f)

    def load_state(self):
        try:
            with open("kanban_state.json", "r") as f:
                tasks = json.load(f)
                for task in tasks:
                    self.columns[task["column"]].add_task(task["text"], task["priority"])
        except FileNotFoundError:
            pass

    def export_tasks(self):
        file = filedialog.asksaveasfilename(defaultextension=".json")
        if file:
            self.save_state()
            with open("kanban_state.json", "r") as f:
                tasks = json.load(f)
            with open(file, "w") as f:
                json.dump(tasks, f)

    def import_tasks(self):
        file = filedialog.askopenfilename(filetypes=[("JSON files", "*.json")])
        if file:
            try:
                with open(file, "r") as f:
                    tasks = json.load(f)
                    for task in tasks:
                        self.columns[task["column"]].add_task(task["text"], task["priority"])
            except json.JSONDecodeError:
                messagebox.showerror(translations[self.lang]["importError"])

    def resize_window(self):
        if self.root.winfo_width() == 800:
            self.root.geometry("400x500")
        else:
            self.root.geometry("800x500")

    def make_draggable(self):
        self.root.overrideredirect(True)
        self.root.bind("<ButtonPress-1>", self.start_move)
        self.root.bind("<B1-Motion>", self.do_move)

    def start_move(self, event):
        self.x = event.x
        self.y = event.y

    def do_move(self, event):
        x = (event.x_root - self.x)
        y = (event.y_root - self.y)
        self.root.geometry(f"+{x}+{y}")

    def toggle_visibility(self):
        if self.root.winfo_viewable():
            self.root.withdraw()
        else:
            self.root.deiconify()

    def change_size(self, event):
        size = self.size_selector.get()
        if size == "small":
            self.root.geometry("400x500")
        elif size == "medium":
            self.root.geometry("800x500")
        elif size == "large":
            self.root.geometry("1200x500")

if __name__ == "__main__":
    root = tk.Tk()
    app = KanbanApp(root)
    root.mainloop()
